SET TERM !!;

ALTER PROCEDURE ARMAR_REPORTE_MENSUAL (
    MES INTEGER,
    ANIO INTEGER,
    TIPO INTEGER)
RETURNS (
    INGRESO VARCHAR (101) CHARACTER SET NONE,
    DISIPLINA VARCHAR (50) CHARACTER SET NONE,
    SALDO DECIMAL (8, 3))
AS
  declare variable DIS INTEGER;
  declare variable CLI INTEGER;
  declare variable CANT INTEGER;
  declare variable PRECIO FLOAT;
  declare variable TIPO_SA INTEGER;
  declare variable NOM_DIS VARCHAR(50);
BEGIN
  /* BUSCAR TODAS LAS DISIPLINAS AEROBICAS POR CANTIDAD */
  FOR select COUNT(NUMERO) as CANTIDAD, DISIPLINA
      From Numeros N where (fecha LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4)))) and pago='S' GROUP BY DISIPLINA, PAGO
      INTO :CANT, :DIS
  DO
    BEGIN
         SELECT NOMBRE FROM DISIPLINAS WHERE (ID_DISIPLINA=:DIS) INTO :DISIPLINA;
         SELECT PRECIO_CLASE FROM DISIPLINAS WHERE (ID_DISIPLINA=:DIS) INTO :PRECIO;
         SALDO = PRECIO*CANT;
         INGRESO = 'Cantidad de Clases '||CAST(CANT AS VARCHAR(10));
         SUSPEND;
    END
  /*BUSCAR TODOS LOS INGRESOS DE LA PARTE DE APARATOS*/
  CANT = 0;
  /*FOR SELECT CLIENTE, DISIPLINA from Aparatos where (fecha_ingreso LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4)))) and paga='S'
      INTO :CLI, :DIS
  DO
  BEGIN
       SELECT NOMBRE||' '||APELLIDO FROM CLIENTES WHERE (ID_CLIENTE=:CLI) INTO :INGRESO;
       SELECT NOMBRE, PRECIO_CLASE FROM DISIPLINAS WHERE (ID_DISIPLINA=:DIS)
       INTO :DISIPLINA, :SALDO;
       CANT = CANT+SALDO;
  END*/
  FOR SELECT CLIENTE, DISIPLINA from PAGO_APARATOS where (EXTRACT(MONTH FROM FECHA_EFECTIVO)=:MES AND EXTRACT(YEAR FROM FECHA_EFECTIVO)=:ANIO)
      INTO :CLI, :DIS
  DO
  BEGIN
       SELECT NOMBRE||' '||APELLIDO FROM CLIENTES WHERE (ID_CLIENTE=:CLI) INTO :INGRESO;
       SELECT NOMBRE, PRECIO_CLASE FROM DISIPLINAS WHERE (ID_DISIPLINA=:DIS)
       INTO :DISIPLINA, :SALDO;
       CANT = CANT+SALDO;
  END
  DISIPLINA = 'Aparatos';
  INGRESO = '--';
  SALDO = CANT;
  SUSPEND;
  /*BUSCAR TODOS LOS INGRESOS DE ARTICULOS*/
  CANT = 0;
  FOR select SUM(CANTIDAD), ID_ARTICULO FROM STOCK WHERE (fecha LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4)))) GROUP BY ID_ARTICULO
      INTO :CANT, :DIS
  DO
  BEGIN
       INGRESO = 'Cant. Articulos: '||CAST(CANT AS VARCHAR(10));
       SELECT NOMBRE, PRECIO FROM ARTICULOS WHERE (ID_ARTICULO=:DIS) INTO :DISIPLINA, :PRECIO;
       SALDO = PRECIO*CANT;
       CANT = CANT+SALDO;
       SUSPEND;
  END
  /*DISIPLINA = 'Articulos';
  INGRESO = '--';
  SALDO = CANT;
  SUSPEND;*/
  /*BUSCAR TODOS LOS INGRESOS DE TROQUELADOS*/
  CANT = 0;
  FOR SELECT COUNT(ID_DISIPLINA), ID_DISIPLINA, SUM(PRECIO) FROM TROQUELADOS WHERE (fecha LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4))))
      GROUP BY ID_DISIPLINA INTO :CANT, :DIS, :SALDO
  DO
  BEGIN
       
       INGRESO = 'Cant. Troquelados: '||CAST (CANT AS VARCHAR(10));
       SELECT NOMBRE FROM DISIPLINAS WHERE (ID_DISIPLINA=:DIS) INTO :DISIPLINA;
       SUSPEND;
  END
  /*BUSCAR LAS ENTRADAS DE PILATES */
  CANT = 0;
  DIS = 0;
  FOR SELECT SUM(PRECIO), COUNT(PRECIO), TIPO FROM PILATES WHERE EXTRACT(MONTH FROM FECHA)=:MES AND EXTRACT(YEAR FROM FECHA) = :ANIO
      GROUP BY TIPO INTO :SALDO, :CANT, :DIS
  DO
  BEGIN
       INGRESO = 'Cant. :'||CAST(CANT AS VARCHAR(5));
       IF (CANT = 1) THEN
            DISIPLINA = 'Clases de Pilates Dobles';
       ELSE
            DISIPLINA = 'Clases de Pilates Simples';
       SUSPEND;
  END
  /*BUSCAR ENTRADAS POR RESERVAS*/
  INGRESO = '--';
  FOR SELECT COUNT(CLIENTE), /*CLIENTE,*/ DISIPLINA FROM RESERVAS WHERE (fecha_reservacion LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4))))
      GROUP BY /*CLIENTE,*/DISIPLINA
      INTO :CANT, /*:CLI,*/ :DIS
  DO
  BEGIN
       IF (NOT EXISTS(SELECT P.ID_DISIPLINA FROM PRACTICA P, DISIPLINAS D WHERE (P.ID_CLIENTE=:CLI AND
          P.ID_DISIPLINA=D.ID_DISIPLINA AND D.NOMBRE = 'Pase libre'))) THEN
       BEGIN
            /*SELECT NOMBRE||' '||APELLIDO FROM CLIENTES WHERE (ID_CLIENTE=:CLI) INTO :INGRESO;*/
            SELECT NOMBRE, PRECIO_CLASE FROM DISIPLINAS WHERE (ID_DISIPLINA=:DIS) INTO :NOM_DIS, :PRECIO;
            DISIPLINA = 'Reservas : '||CAST (CANT AS VARCHAR(5))||' En '||NOM_DIS;
            SALDO = PRECIO*CANT;
            SUSPEND;
       END
  END
  /*BUSCAR LAS ENTRADAS DE CAJA VARIAS*/
  DISIPLINA =  'Entradas Varias';
  INGRESO = '--';
  FOR SELECT /*DESCRIPCION,*/ SUM(PRECIO) FROM ENTRADAS 
      WHERE (fecha LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4))))
      INTO /*:INGRESO, :DISIPLINA, */:SALDO
  DO
  BEGIN
       SUSPEND;
  END
  /*BUSCAR LAS SALIDAS DE CAJA SOLO DESDE EL FORMULARIO NO DEL PREVIEW*/
  DISIPLINA = 'Salidas Varias';
  INGRESO = '--';
  IF (TIPO = 1) THEN
  BEGIN
       FOR SELECT SUM(CANTIDAD), TIPO FROM SALIDAS
           WHERE (fecha LIKE '%'||(CAST(:MES AS VARCHAR(2)))||'/'||(CAST (:ANIO AS VARCHAR(4)))) GROUP BY TIPO INTO :SALDO,:TIPO_SA
       DO
       BEGIN
            SELECT DESCRIPCION FROM TIPO_SALIDA WHERE ID_TIPO=:TIPO_SA INTO :DISIPLINA;
            SUSPEND;
       END
  END
END !!

SET TERM ;!!




